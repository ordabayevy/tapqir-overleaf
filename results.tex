\section*{Results}
\paragraph{Data analysis pipeline.} % Figure 1B,C,D
The initial steps in CoSMoS data analysis involve preprocessing the data set (Fig.~1b) to map the spatial relationship between target and binder images, correct for microscope drift (if any) and list the locations of target molecules. Software packages that perform these preprocessing steps are widely available \cite{Friedman2015-nx, Smith2019-yb}.

The input into Tapqir consists of the time sequence of images (Fig. 1b, right). For colocalization analysis, it is sufficient to consider the image area local to the target molecule. This analyzed area of interest (AOI) needs to be several times the diameter of a diffraction-limited spot to include both the spot and the surrounding background (Fig. 1c). 

In addition to AOIs centered at target molecules, it is useful to also select negative control AOIs from randomly selected sites at which no target molecule is present (Fig. 1b,d). In Tapqir, such off-target control data is analyzed jointly with on-target data and serves to estimate the background level of target-nonspecific binding. 

Once provided with the preprocessing data and image sequence, Tapqir computes for each frame of each AOI the  probability, $p(\mathsf{specific})$, that a target-specific fluorescence spot is present.   The $p(\mathsf{specific})$ values that are output are subsequently used to extract information about the kinetics and thermodynamics of the target-binder interaction.

\paragraph{Bayesian image classification analysis.}
Tapqir calculates $p(\mathsf{specific})$ values using an objective image classification method built on a rigorous Bayesian statistical approach to the CoSMoS image analysis problem. The Bayesian approach has three components. First, we define a probabilistic model of the CoSMoS images. The probabilistic model is a mathematical formalism that describes the AOI images in terms of a set of parameter values.  The model is probabilistic in that each parameter is specified to have a probability distribution that defines the likelihood that it can take on particular values. Model parameters describe physically realistic image features such as photon shot-noise. Second, we specify prior distributions for the parameters of the model. These priors embed pre-existing knowledge about the CoSMoS experiment, such as the fact that target-specific spots will be close to the target molecule locations. Third, we infer the values of the model parameters, including $p(\mathsf{specific})$, using Bayes' rule \cite{Bishop2006-oa}. The Tapqir analysis is “time-independent”, meaning that we ignore the time dimension of the recording -- the order of the images does not affect the results. 

\paragraph{Probabilistic image model and parameters.} % Figure 2A,B,C
A single AOI image from a CoSMoS data set is a matrix of noisy pixel intensity values.  In each image, multiple binder molecule fluorescence spots can be present. Fig.~2a shows an example image where two spots are present; one spot is located near the target molecule at the center of the image and another is off-target. 

The probabilistic model mathematically generates images $D$ as follows.  We construct a noise-free AOI image $\mu^I$ as a constant average background intensity $b$ summed with fluorescence spots modeled as 2-D Gaussians $\mu^S$, which accurately approximate the microscope point spread function \cite{Zhang2007-rb} (Fig. 2b). Each 2-D Gaussian is described by parameters integrated intensity $h$, width $w$, and position ($x$, $y$). We define $K$ as the maximum number of spots that can be present in a single AOI image.  For the data we typically encounter, $K = 2$. Since the spots may be present or not in a particular image, we define the $K = 2$ binary indicators $m_{\mathsf{spot}(1)}$ and $m_{\mathsf{spot}(2)}$.  Each indicator can take a value of either 0 denoting spot absence or 1 denoting spot presence. 

The resulting mixture model has four possible combinations for $m_{\mathsf{spot}(1)}$ and $m_{\mathsf{spot}(2)}$: (1) a no-spot image that contains only background (Fig. 2b, top left), (2) a single-spot image that contains the first binder molecule spot superimposed on background (Fig. 2b, bottom left), (3) a single-spot image that contains the second binder molecule spot superimposed on background (Fig. 2b, top right), and (4) a two-spot image that contains both binder molecule spots superimposed on background (Fig. 2b, bottom right).

Among the spots that are present in an AOI image, by assumption at most only one can be target-specific. We introduce the index parameter $\theta$ which identifies the target-specific spot  when it is present (Fig. 2c, middle and right) and equals zero when it is absent (Fig. 2c, left). Since the off-target control AOIs by definition contain only non-specific binding, $\theta = 0$ for all off-target images. 

Finally, to construct realistic noisy images $D$ from the noise-free AOI images $\mu^I$, the model adds intensity-dependent noise to each pixel.  Each measured pixel intensity in a single-molecule fluorescence image has a noise contribution from photon counting (shot noise) and can also contain additional noise arising from electronic amplification \cite{Van_Vliet1998-jk}. The result is a characteristic linear relationship between the noise variance and mean intensity with slope defining the image gain $g$. This relationship is used to compute the random pixel noise values (see Methods).

The resulting probabilistic image model can be interpreted as a generative process that produces the observed image data $D$. A graphical representation of the probabilistic relationships in the model is shown in Fig. 2d (see also Extended Data Fig. 1a and Methods Algorithm 2). A complete description of the model is given in Methods.  

\paragraph{Parameter prior distributions.}
Specifying prior probability distributions for model parameters is essential for Bayesian analysis and allows us to incorporate pre-existing knowledge about the experimental design. For most model parameters, there is no strong prior information so we use uninformative prior distributions (see Methods). However, we have strong expectations for the positions of specific and non-specific binder molecules that can be expressed as prior distributions and used effectively to discriminate between the two. Non-specific binding can occur anywhere on the surface with equal probability and thus has a uniform prior distribution across the AOI image. Target-specific binding, on the other hand, is colocalized with the target molecule and thus has a prior distribution peaked at the AOI center (Extended Data Fig. 1b). The width of the prior distribution for specific binding location, proximity parameter $\sigma^{xy}$, depends on multiple experiment characteristics such as the spot localization accuracy and the mapping accuracy between target and binder imaging channels. Prior distributions for parameters $\theta$ and $m$ are defined in terms of the average number of target-specific and target non-specific spots per AOI image, $\pi$ and $\lambda$, respectively. To allow convenient use of the algorithm, we infer values of $\sigma^{xy}$, $\pi$, and $\lambda$ appropriate to a given data set using a hierarchical Bayesian analysis (see Methods).

\paragraph{Bayesian inference and implementation.}
Tapqir calculates posterior distributions of model parameters conditioned on the observed data by using Bayes' theorem. In particular, Tapqir approximates posterior distributions using a variational inference approach implemented in Pyro \cite{Bingham2019-qy}.  Complete details of the implementation are given in the Methods section.

\paragraph{Tapqir analysis.} % Figure 3A, B
To test the approach, we used Tapqir to analyze simulated CoSMoS image data with a high SNR of 3.76 as well as data from the experiment shown in Fig. 1, which has a lower SNR of 1.63. The simulated data were generated using the same model that was used for analysis (Fig. 2d). Tapqir correctly detects fluorescent spots in both simulated and experimental images (compare ``AOI images'' and ``Spot-detection'' rows in Fig. 3). The program precisely calculates the position ($x$,$y$) and intensity ($h$) for each spot and also determines the background intensity ($b$) for each image without requiring a separate analysis. 

For a spot to be classified as target-specific (Fig. 3, filled circles in spot detection plot) it must have a high spot probability and be colocalized with the target molecule at the center of the AOI. For example, spot 2 in frame 110 of Fig. 3a and spot 1 in frame 635 of Fig. 3b both are calculated to have high probabilities of being target-specific [$p(\theta=2) = 0.997$ and $p(\theta=1) = 0.886$, respectively]. On the other hand, spot 2 in frame 108 of Fig. 3a and spot 2 in frame 635 of Fig. 3b have low probabilities of being target-specific [$p(\theta=2) = 2 \times 10^{-5}$ and $p(\theta=2) = 8 \times 10^{-7}$, respectively]. For a given image, the probability $p(\mathsf{specific})$ that any target-specific spot is present is obtained as the sum $p(\theta=1) + p(\theta=2)$. Spot probability values for all frames shown in Fig. 3 are reported in Extended Data Fig. 2.  

\paragraph{Tapqir robustly fits experimental data sets with different characteristics.}
Next, we evaluated how well the model fits data sets encompassing a range of characteristics found in typical CoSMoS experiments. We analyzed four experimental data sets with varying SNR, frequency of target-specific spots, and frequencies of non-specific spots (Extended Data Table 1). We then sampled AOI images from the posterior distributions of parameters (a method known as posterior predictive checking \cite{Gelman2013-ro}). These posterior predictive simulations accurately reproduce the experimental AOI appearances, recapitulating the noise characteristics and the numbers, intensities, shapes, and locations of spots (Extended Data Fig. 3).  The distributions of pixel intensities across the AOI are also closely reproduced (Extended Data Fig. 3, histograms) confirming that the noise model is accurate. Taken together, these results confirm that the model is rich enough to accurately capture the full range of image characteristics from CoSMoS data sets taken over different experimental conditions.  Importantly, all of the results on different experimental data sets were obtained using the same model (Fig. 2d) and the same priors.  No tuning of the algorithm or prior measurement of data-set-specific properties was needed to achieve good fits for all data sets.

\paragraph{Tapqir accuracy on simulated data with known global parameter values.}
Next, we evaluated Tapqir's ability to reliably infer the values of global model parameters. To  accomplish this, we generated simulated data sets using a wide range of randomized parameter values and then fit the simulated data to the model (Supplementary Data 2). Fit results show that global model parameters (i.e., average specific spot probability $\pi$, nonspecific binding rate $\lambda$, proximity $\sigma^{xy}$, and gain $g$; see Fig. 2d) are close to the simulated values (Extended Data Fig. 4 and Supplementary Data 2). This suggests that CoSMoS data contains enough information to reliably infer global model parameters and that the model is not obviously overparameterized. 

\paragraph{Tapqir classification accuracy.} Having tested the basic function of the algorithm, we next turned to the key question of how accurately Tapqir can detect target-specific spots in data sets of increasing difficulty.

We first examined the accuracy of target-specific spot detection in simulated data sets with decreasing SNR (Supplementary Data 3). By eye, spots can be readily discerned at $\mathrm{SNR}>1$ but cannot be clearly seen at $\mathrm{SNR}<1$ (Fig. 4a). Tapqir gives similar or better performance:  if an image contains a target-specific spot, Tapqir correctly assigns it a target-specific spot probability $p(\mathsf{specific})$ that is on average close to one as long as SNR is adequate (i.e., $\mathrm{SNR}>1$) (Fig. 4b).  In contrast, mean $p(\mathsf{specific})$ sharply decreases at $\mathrm{SNR}<1$, consistent with the subjective impression that no spot is seen under those conditions.  In particular, images that contain a target-specific spot are almost always assigned a high $p(\mathsf{specific})$ for high SNR data and almost always assigned low $p(\mathsf{specific})$ for low SNR data (Fig. 4c, green).  At marginal $\mathrm{SNR} \simeq 1$, these images are assigned a broad distribution of $p(\mathsf{specific})$ values, accurately reflecting the uncertainty in classifying such data.  Just as importantly, images with no target-specific spot are almost always assigned $p(\mathsf{specific}) < 0.5$, correctly reflecting the absence of the spot (Fig. 4c, gray).

Ideally, we want to correctly identify target-specific binding when it occurs but also to avoid incorrectly identifying target-specific binding when it does not occur. To quantify Tapqir's classification accuracy, we next examined binary image classification statistics. Binary classification predictions were obtained by thresholding $p(\mathsf{specific})$ at $0.5$. We then calculated two complementary statistics: \textit{recall} and \textit{precision} \cite{Fawcett2006-bq} (Fig. 4d; see Methods). Recall is defined as the fraction of true target-specific spots that are correctly predicted. Recall is high at high SNR and decreases at lower SNR. Recall is a binary analog of the mean $p(\mathsf{specific})$ for the subset of images containing target-specific spots; as expected the two quantities have similar dependencies on SNR (compare Fig. 4b and Fig. 4d, black). Precision is the fraction of predicted target-specific spots that are correctly predicted. Precision is near one at all SNR values tested (Fig. 4d, red); this shows that the algorithm rarely misclassifies an image as containing a target-specific spot when none is present. 

In order to quantify the effects of both correctly and incorrectly classified images in a single statistic, we used the Matthews Correlation Coefficient (MCC) \cite{Matthews1975-rw} (see Methods). The MCC is equivalent to the Pearson correlation coefficient between the predicted and true classifications, giving 1 for a perfect match, 0 for a random match, and $-1$ for complete disagreement. The MCC results (Fig. 4d, blue) suggest that the overall performance of Tapqir is excellent at SNR $\ge 1$: the program rarely misses target-specific spots that are in reality present and rarely falsely reports a target-specific spot when none is present.  

The analyses of Fig. 4b-d examined Tapqir performance on data in which the rate of target-nonspecific binding is moderate ($\lambda = 0.15$ non-specific spots per AOI image on average).  We next examined the effects of increasing the non-specific rate.  In particular, we used simulated data (Supplementary Data 1) with high $\mathrm{SNR} = 3.76$ to test the classification accuracy of Tapqir at different non-specific binding rates up to $\lambda = 1$, a value considerably higher than typical of usable experimental data (the experimental data sets in Extended Data Table 1 have $\lambda$ ranging from 0.04 to 0.3).   In analysis of these data sets, a few images with target-specific spots are misclassified as not having a specific spot ($p(\mathsf{specific})$ near zero) or as being ambiguous ($p(\mathsf{specific})$ near 0.5) (Fig. 4f, green bars), and a few images with target-nonspecific spots are misclassified as having specific spot ($p(\mathsf{specific})$ near or above 0.5) (Fig. 4f, gray bars), but these misclassifications only occurred at the unrealistically high $\lambda = 1$ value.  Even in the simulation with this highest $\lambda$ value, Tapqir accurately identified target-specific spots (Fig. 4e,f) and returned excellent binary classification statistics (Fig.~4g). 

We also tested another extreme case by simulating data sets with no target-specific binding at both low and high non-specific binding rates (Supplementary Data 4). Analysis of such data (Fig. 4h) shows that no target-specific binding (i.e., $p(\mathsf{specific}) > 0.6$) was detected even under the highest non-specific binding rate, demonstrating that Tapqir is robust to false-positive target-specific spot detection even under these extreme conditions. 

\paragraph{Kinetic and thermodynamic analysis of molecular interactions.}
The most widespread application of CoSMoS experiments is to measure rate and equilibrium constants for the binding interaction of the target and binder molecules being studied.  We next tested whether these constants can be accurately determined using Tapqir-calculated posterior predictions. 

We first simulated CoSMoS data sets (Supplementary Data 5) that reproduced the behavior of a one-step association/dissociation reaction mechanism (Fig. 5a and Fig. 5b, blue). Simulated data were analyzed with Tapqir yielding $p(\mathsf{specific})$ values for each frame (e.g., Fig. 5b, green). To estimate rate constants we sampled a family of binary time records (Fig. 5b, black) from $p(\mathsf{specific})$. Each family member has well-defined target-specific binder-present and binder-absent intervals $\Delta t_\mathsf{on}$ and $\Delta t_\mathsf{off}$, respectively. Each of these time records was then analyzed with a two-state hidden Markov model (HMM) (see Methods), producing a distribution of inferred rate constants from which we calculated mean values and their uncertainties (Fig.~5c,d). Comparison of the simulated and inferred values shows that both $k_\mathsf{on}$ and $k_\mathsf{off}$ rate constants are accurate within 30\% at nonspecific binding rates typical of experimental data ($\lambda \leq 0.5$). At higher nonspecific binding rates, rare interruptions caused by false-positive and false-negative spot detection shorten $\Delta t_\mathsf{on}$ and $\Delta t_\mathsf{off}$ distributions, leading to moderate systematic overestimation of the association and dissociation rate constants.

From the same simulated data we calculated the equilibrium constant $K_\mathsf{eq}$ and its uncertainty. This calculation does not require a time-dependent model and can be obtained directly from the posterior distribution of the average specific-binding probability $\pi$. The estimated equilibrium constants are highly accurate even at excessively high values of $\lambda$ (Fig. 5e).  The high accuracy results from the fact that equilibrium constant measurements in general are much less affected than kinetic measurements by occasional errors in spot detection. 

% Figure 7
The forgoing analysis shows that Tapqir can accurately recover kinetic and thermodynamic constants from simulated CoSMoS data.  However, experimental CoSMoS data sets can be more diverse.  In addition to having different SNR and non-specific binding frequency values, they also may have non-idealities in spot shape (caused by optical aberrations) and in noise (caused by molecular diffusion in and out of the TIRF evanescent field).  In order to see if Tapqir analysis is robust to these and other properties of real experimental data, we analyzed several CoSMoS data sets taken from different experimental projects (Extended Data Table 1). We first visualized the results as probabilistic rastergrams (Fig. 6a, Extended Data Figs. 5a, 6a, and 7a), in which each horizontal line represents the time record from a single AOI.  Unlike the binary spot/no-spot rastergrams in previous studies \cite{Friedman2013-sf,Rosen2020-zn} we plotted the Tapqir-calculated spot probability $p(\mathsf{specific})$ using a color scale.  This representation allows a more nuanced understanding of the data.  For example, Fig. 6a reveals that while the long-duration spot detection events typically are assigned a high probability (yellow), some of the shortest duration events have an intermediate $p(\mathsf{specific})$ (green) indicating that the assignment of these as target-specific is uncertain.  

To demonstrate the utility of Tapqir for kinetic analysis of real experimental data, we measured binder association rate constants in previously published experimental data sets (Extended Data Table 1).  We employed our previous strategy \cite{Friedman2006-kb} of analyzing the duration of the binder-absent intervals that preceded the first binding event.  Such time-to-first binding analysis improves the accuracy of association rate constant estimates relative to those obtained by analyzing all $\Delta t_\mathsf{off}$ values by minimizing the effects of target molecules occupied by photobleached binders, dye blinking and false negative dropouts that occur within a continuous binder dwell interval.  To perform a time-to-first-binding analysis using Tapqir, we used the posterior sampling method (as in Fig. 5b, black records) to determine the initial $\Delta t_\mathsf{off}$ in each AOI record. These data were fit to a kinetic model \cite{Friedman2006-kb} in which only a fraction of target molecules $A_\mathsf{f}$ were binding competent and which includes both exponential target-specific association with rate constant $k_\mathsf{a}$, as well as exponential non-specific association with rate constant $k_\mathsf{ns}$ (Fig. 6b, Extended Data Fig. 5b, 6b, and 7b).  The Tapqir-derived fits showed excellent agreement with the kinetic model.  

To further assess the utility of the Tapqir method we compared the Tapqir kinetic results with those from a previously published method that analyzes images using an empirical binary ``spot-picker'' method \cite{Friedman2006-kb} (Fig. 6c, Extended Data Fig. 5c, 6c, and 7c). The values of the association rate constant $k_\mathsf{a}$ obtained using these two methods are in good agreement with each other (Fig. 6d, Extended Data Figs. 5d, 6d, and 7d). We emphasize that while Tapqir is fully objective, achieving this result with the spot-picker method required optimization by subjective adjustment of spot detection thresholds.  We noted some differences between the two methods in the non-specific association rate constants $k_\mathsf{ns}$. Differences are expected because these parameters are defined differently in the different non-specific binding models used in Tapqir and  spot-picker (see Methods).
