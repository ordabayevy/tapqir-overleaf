\section{Results}

\subsection{Data analysis pipeline}

The initial steps in CoSMoS data analysis involve preprocessing the data set (\FIG{cosmos_experiment}B) to map the spatial relationship between target and binder images, correct for microscope drift (if any) and list the locations of target molecules. Software packages that perform these preprocessing steps are widely available (e.g., \cite{Friedman2015-nx, Smith2019-yb}).

The input into Tapqir consists of the time sequence of images (\FIG{cosmos_experiment}B, right). For colocalization analysis, it is sufficient to consider the image area local to the target molecule. This analyzed area of interest (AOI) needs to be several times the diameter of a diffraction-limited spot to include both the spot and the surrounding background (\FIG{cosmos_experiment}C). 

In addition to AOIs centered at target molecules, it is useful to also select negative control AOIs from randomly selected sites at which no target molecule is present (\FIG{cosmos_experiment}B,D). In Tapqir, such off-target control data is analyzed jointly with on-target data and serves to estimate the background level of target-nonspecific binding. 

Once provided with the preprocessing data and image sequence, Tapqir computes for each frame of each AOI the  probability, $p(\mathsf{specific})$, that a target-specific fluorescence spot is present.   The $p(\mathsf{specific})$ values that are output can then be used to extract information about the kinetics and thermodynamics of the target-binder interaction.

\subsection{Bayesian image classification analysis}

Tapqir calculates $p(\mathsf{specific})$ values using an objective image classification method built on a rigorous Bayesian statistical approach to the CoSMoS image analysis problem. The Bayesian approach has three components. First, we define a probabilistic model of the CoSMoS images. The probabilistic model, \emph{cosmos}, is a mathematical formalism that describes the AOI images in terms of a set of parameter values.  The model is probabilistic in that each parameter is specified to have a probability distribution that defines the likelihood that it can take on particular values. Model parameters describe physically realistic image features such as the characteristic fluorescence spot width. Second, we specify prior distributions for the parameters of the model. These priors embed pre-existing knowledge about the CoSMoS experiment, such as the fact that target-specific spots will be close to the target molecule locations. Third, we infer the values of the model parameters, including $p(\mathsf{specific})$, using Bayes' rule \citep{Bishop2006-oa,Kinz-Thompson2021-tb}. The \emph{cosmos} model is “time-independent”, meaning that we ignore the time dimension of the recording -- the order of the images does not affect the results. 

\subsection{Probabilistic image model and parameters} % Figure 2A,B,C

A single AOI image from a CoSMoS data set is a matrix of noisy pixel intensity values.  In each image, multiple binder molecule fluorescence spots can be present. \FIG{graphical_model}A shows an example image where two spots are present; one spot is located near the target molecule at the center of the image and another is off-target.

The probabilistic model mathematically generates images $D$ as follows.  We construct a noise-free AOI image $\mu^I$ as a constant average background intensity $b$ summed with fluorescence spots modeled as 2-D Gaussians $\mu^S$, which accurately approximate the microscope point spread function \citep{Zhang2007-rb} (\FIG{graphical_model}B). Each 2-D Gaussian is described by parameters integrated intensity $h$, width $w$, and position ($x$, $y$). We define $K$ as the maximum number of spots that can be present in a single AOI image.  For the data we typically encounter, $K$ = 2 is sufficient. Since the spots may be present or not in a particular image, we define the $K$ = 2 binary indicators $m_{\mathsf{spot}(1)}$ and $m_{\mathsf{spot}(2)}$.  Each indicator can take a value of either 0 denoting spot absence or 1 denoting spot presence. 

The resulting mixture model has four possible combinations for $m_{\mathsf{spot}(1)}$ and $m_{\mathsf{spot}(2)}$: (1) a no-spot image that contains only background (\FIG{graphical_model}B, top left), (2) a single-spot image that contains the first binder molecule spot superimposed on background (\FIG{graphical_model}B, bottom left), (3) a single-spot image that contains the second binder molecule spot superimposed on background (\FIG{graphical_model}B, top right), and (4) a two-spot image that contains both binder molecule spots superimposed on background (\FIG{graphical_model}B, bottom right).

Among the spots that are present in an AOI image, by assumption at most only one can be target-specific. We use a \emph{state} parameter $z$ to indicate target-specific spot absence ($z=0$) or presence ($z=1$) in an AOI image. We also introduce an \emph{index} parameter $\theta$ that identifies which of the spots is the target-specific spot  when it is present ($z = 1$) (e.g., \FIG{graphical_model}C, middle and right have $\theta = 1$ and $\theta = 2$, respectively) and equals zero when it is absent ($z = 0$) (e.g., \FIG{graphical_model}C, left). Since the off-target control AOIs by definition contain only non-specific binding, $z = 0$ and $\theta = 0$ for all off-target AOIs. 

Finally, to construct realistic noisy AOI images $D$ from the noise-free images $\mu^I$, the model adds intensity-dependent noise to each pixel.  Each measured pixel intensity in a single-molecule fluorescence image has a noise contribution from photon counting (shot noise) and can also contain additional noise arising from electronic amplification \citep{Van_Vliet1998-jk}. The result is a characteristic linear relationship between the noise variance and mean intensity with slope defining the gain $g$. This relationship is used to compute the random pixel noise values (see Materials and Methods).

The resulting probabilistic image model can be interpreted as a generative process that produces the observed image data $D$. A graphical representation of the probabilistic relationships in the model is shown in \FIG{graphical_model}D. A complete description of the model is given in Materials and Methods and \FIGSUPP[graphical_model]{extended}.  
 
\include{figures/graphical_model}

\subsection{Parameter prior distributions}

Specifying prior probability distributions for model parameters is essential for Bayesian analysis and allows us to incorporate pre-existing knowledge about the experimental design. For most model parameters, there is no strong prior information so we use uninformative prior distributions (see Materials and Methods). However, we have strong expectations for the positions of specific and non-specific binder molecules that can be expressed as prior distributions and used effectively to discriminate between the two. Non-specific binding can occur anywhere on the surface with equal probability and thus has a uniform prior distribution across the AOI image. Target-specific binding, on the other hand, is colocalized with the target molecule and thus has a prior distribution peaked at the AOI center (\FIGSUPP[graphical_model]{xy}). The width of this peak, proximity parameter $\sigma^{xy}$, depends on multiple features of the experiment such as the spot localization accuracy and the mapping accuracy between target and binder imaging channels. Prior distributions for parameters $\theta$ and $m$ are defined in terms of the average number of target-specific and target non-specific spots per AOI image, $\pi$ and $\lambda$, respectively. To facilitate convenient use of the algorithm, it is not necessary to pre-specify values of $\sigma^{xy}$, $\pi$, and $\lambda$.  Instead, values of these parameters appropriate to a given data set are calculated automatically using a hierarchical Bayesian analysis (see Materials and Methods; for hierarchical modeling see Chapter 5 of \cite{Gelman2013-ro}).

\subsection{Bayesian inference and implementation}

Tapqir calculates posterior distributions of model parameters conditioned on the observed data by using Bayes' theorem. In particular, Tapqir approximates posterior distributions using a variational inference approach implemented in Pyro \citep{Bingham2019-qy}.  Complete details of the implementation are given in Materials and Methods.

\subsection{Tapqir analysis}

To test the approach, we used Tapqir to analyze simulated CoSMoS image data with a comparatively high SNR of 3.76 as well as data from the experiment shown in \FIG{cosmos_experiment}B-D, which has a lower SNR of 1.61. The simulated data were generated using the same \emph{cosmos} model (\FIG{graphical_model}D) that was used for analysis. Tapqir correctly detects fluorescent spots in both simulated and experimental images (compare ``AOI images'' and ``Spot-detection'' rows in \FIG{tapqir_analysis}). The program precisely calculates the position ($x$, $y$), intensity ($h$), and width ($w$) for each spot and also determines the background intensity ($b$) for each image without requiring a separate analysis. These parameters confirm the desired behavior of the model and could be used in further calculations.  However, the most important output of the analysis is assessment of the presence of target-specific binding.  For each AOI image, we calculate $p(\mathsf{specific}) \equiv p(z=1)$ (\FIG{tapqir_analysis}, green), the probability that any target-specific spot is present. Spots determined as likely target-specific ($p(\mathsf{specific}) > 0.5$) are represented as filled circles in the spot detection row of \FIG{tapqir_analysis}. For a particular spot to have high $p(\mathsf{specific})$, it must have a high spot probability and be colocalized with the target molecule at the center of the AOI (\FIGSUPP[tapqir_analysis]{probs}).  

\include{figures/tapqir_analysis}

\subsection{Tapqir robustly fits experimental data sets with different characteristics}

Next, we evaluated how well the model fits data sets encompassing a range of characteristics found in typical CoSMoS experiments. We analyzed four experimental data sets with varying SNR, frequency of target-specific spots, and frequencies of non-specific spots (\TABLE{datasets}). We then sampled AOI images from the posterior distributions of parameters (a method known as posterior predictive checking \citep{Gelman2013-ro}). These posterior predictive simulations accurately reproduce the experimental AOI appearances, recapitulating the noise characteristics and the numbers, intensities, shapes, and locations of spots (\FIGSUPP[tapqir_analysis]{ppc}, images).  The distributions of pixel intensities across the AOI are also closely reproduced (\FIGSUPP[tapqir_analysis]{ppc}, histograms) confirming that the noise model is accurate. Taken together, these results confirm that the model is rich enough to accurately capture the full range of image characteristics from CoSMoS data sets taken over different experimental conditions.  Importantly, all of the results on different experimental data sets were obtained using the same model (\FIG{graphical_model}D) and the same priors (Materials and Methods).  No tuning of the algorithm or prior measurement of data-set-specific properties was needed to achieve good fits for all data sets.

\subsection{Tapqir accuracy on simulated data with known global parameter values}

Next, we evaluated Tapqir's ability to reliably infer the values of global model parameters. To  accomplish this, we generated simulated data sets using a wide range of randomized parameter values and then fit the simulated data to the model (Supplementary File 2). Fit results show that global model parameters (i.e., average specific spot probability $\pi$, nonspecific binding density $\lambda$, proximity $\sigma^{xy}$, and gain $g$; see \FIG{graphical_model}D) are close to the simulated values (\FIGSUPP[tapqir_analysis]{randomized} and Supplementary File 2). This suggests that CoSMoS data contains enough information to reliably infer global model parameters and that the model is not obviously overparameterized. 

\subsection{Tapqir classification accuracy}

Having tested the basic function of the algorithm, we next turned to the key question of how accurately Tapqir can detect target-specific spots in data sets of increasing difficulty.

We first examined the accuracy of target-specific spot detection in simulated data sets with decreasing SNR (Supplementary File 3). By eye, spots can be readily discerned at SNR > 1 but cannot be clearly seen at SNR < 1 (\FIG{tapqir_performance}A). Tapqir gives similar or better performance:  if an image contains a target-specific spot, Tapqir correctly assigns it a target-specific spot probability $p(\mathsf{specific})$ that is on average close to one as long as SNR is adequate (i.e., SNR > 1) (\FIG{tapqir_performance}B).  In contrast, mean $p(\mathsf{specific})$ sharply decreases at SNR < 1, consistent with the subjective impression that no spot is recognized under those conditions.  In particular, images that contain a target-specific spot are almost always assigned a high $p(\mathsf{specific})$ for high SNR data and almost always assigned low $p(\mathsf{specific})$ for low SNR data (\FIG{tapqir_performance}C, green).  At marginal SNR $\simeq$ 1, these images are assigned a broad distribution of $p(\mathsf{specific})$ values, accurately reflecting the uncertainty in classifying such data.  Just as importantly, images with no target-specific spot are almost always assigned $p(\mathsf{specific}) < 0.5$, correctly reflecting the absence of the spot (\FIG{tapqir_performance}C, gray).

Ideally, we want to correctly identify target-specific binding when it occurs but also to avoid incorrectly identifying target-specific binding when it does not occur. To quantify Tapqir's classification accuracy, we next examined binary image classification statistics. Binary classification predictions were obtained by thresholding $p(\mathsf{specific})$ at $0.5$. We then calculated two complementary statistics: \textit{recall} and \textit{precision} \citep{Fawcett2006-bq} (\FIG{tapqir_performance}D; see Materials and Methods). Recall is defined as the fraction of true target-specific spots that are correctly predicted. Recall is high at high SNR and decreases at lower SNR. Recall is a binary analog of the mean $p(\mathsf{specific})$ for the subset of images containing target-specific spots; as expected the two quantities have similar dependencies on SNR (compare \FIG{tapqir_performance}B and \FIG{tapqir_performance}D, black). Precision is the fraction of predicted target-specific spots that are correctly predicted. Precision is near one at all SNR values tested (\FIG{tapqir_performance}D, red); this shows that the algorithm rarely misclassifies an image as containing a target-specific spot when none is present. 

In order to quantify the effects of both correctly and incorrectly classified images in a single statistic, we used the binary classification predictions to calculate the Matthews Correlation Coefficient (MCC) \citep{Matthews1975-rw} (see Materials and Methods). The MCC is equivalent to the Pearson correlation coefficient between the predicted and true classifications, giving 1 for a perfect match, 0 for a random match, and -1 for complete disagreement. The MCC results (\FIG{tapqir_performance}D, blue) suggest that the overall performance of Tapqir is excellent at SNR $\ge$ 1: the program rarely misses target-specific spots that are in reality present and rarely falsely reports a target-specific spot when none is present.  

The analyses of \FIG{tapqir_performance}B-D examined Tapqir performance on data in which the rate of target-nonspecific binding is moderate ($\lambda$ = 0.15 non-specific spots per AOI image on average).  We next examined the effects of increasing the non-specific rate.  In particular, we used simulated data (Supplementary File 1) with high SNR = 3.76 to test the classification accuracy of Tapqir at different non-specific binding densities up to $\lambda$ = 1, a value considerably higher than typical of usable experimental data (the experimental data sets in \TABLE{datasets} have $\lambda$ ranging from 0.04 to 0.30).   In analysis of these data sets, a few images with target-specific spots are misclassified as not having a specific spot ($p(\mathsf{specific})$ near zero) or as being ambiguous ($p(\mathsf{specific})$ near 0.5) (\FIG{tapqir_performance}F, green bars), and a few images with target-nonspecific spots are misclassified as having specific spot ($p(\mathsf{specific})$ near or above 0.5) (\FIG{tapqir_performance}F, gray bars), but these misclassifications only occurred at the unrealistically high $\lambda$ = 1 value.  Even in the simulation with this highest $\lambda$ value, Tapqir accurately identified target-specific spots (\FIG{tapqir_performance}E,F) and returned excellent binary classification statistics (\FIG{tapqir_performance}G). 

A weakness of some existing image-based CoSMoS spot discrimination methods is that target-nonspecific binding adjacent to a target-specific spot can interfere with correctly identifying the latter as target-specific.  The very high recall values obtained at $\lambda$ = 1 (\FIG{tapqir_performance}G) confirm that there are few such misidentifications by Tapqir even at high non-specific binding densities.  This good performance is likely facilitated by the feature of the Tapqir model that explicitly includes the possibility that both a specifically and a non-specifically bound spot may occur simultaneously in the same AOI. Consistent with this interpretation, we see effective detection of the specific and non-specific spots even in example AOIs in which the two spots are so closely spaced that they are not completely resolved (\FIG{tapqir_performance}H). In contrast, tests of existing CoSMoS image classification methods show that images with target-nonspecific spots are prone to misclassification.  As discussed previously \citep{Friedman2015-nx}, methods based on thresholding of integrated AOI intensities are prone to incorrectly classify target-nonspecific spots as target-specific.  Conversely, an existing ``spot-picker'' method based on empirical binary classification of 2-D AOI images \citep{Friedman2015-nx} is much more likely than Tapqir to fail to detect target specific spots when there is a nearby non-specific spot   (\FIGSUPP[tapqir_performance]{fn}).  This contributes to the superior overall performance we see for Tapqir vs. spot-picker on the $\lambda$ = 1 data set (recall 0.993 vs. 0.919; precision 0.943 vs. 0.873; MCC 0.961 vs. 0.874).

To further evaluate whether Tapqir is prone to misidentifying target-nonspecific spots as specific, we  simulated data sets with no target-specific binding at both low and high non-specific binding densities (Supplementary File 4). Analysis of such data (\FIG{tapqir_performance}I) shows that no target-specific binding (i.e., $p(\mathsf{specific}) > 0.6$) was detected even under the highest non-specific binding density, demonstrating that Tapqir is robust to false-positive target-specific spot detection even under these extreme conditions. 

\include{figures/tapqir_performance}

Since target-nonspecific spots are built into the \emph{cosmos} model, there is no need to choose excessively small AOIs in an attempt to exclude non-specific spots from analysis. We found that reducing AOI size (from 14 x 14 to 6 x 6 pixels) did not appreciably affect analysis accuracy on simulated data (\TABLE{aoisize}). In analysis of experimental data, smaller AOI sizes caused occasional changes in calculated $p(\mathsf{specific})$ values reflecting apparent missed detection of a few spots (\FIGSUPP[tapqir_analysis]{size}). Out of caution, we therefore used 14 x 14 pixel AOIs routinely, even though the larger AOIs somewhat reduced computation speed (\TABLE{aoisize} and \FIGSUPP[tapqir_analysis]{size}).

\subsection{Kinetic and thermodynamic analysis of molecular interactions}

The most widespread application of CoSMoS experiments is to measure rate and equilibrium constants for the binding interaction of the target and binder molecules being studied.  We next tested whether these constants can be accurately determined using Tapqir-calculated posterior predictions. 

We first simulated CoSMoS data sets (Supplementary File 5) that reproduced the behavior of a one-step association/dissociation reaction mechanism (\FIG{kinetic_analysis}A and \FIG{kinetic_analysis}B, blue). Simulated data were analyzed with Tapqir yielding $p(\mathsf{specific})$ values for each frame (e.g., \FIG{kinetic_analysis}B, green). We wanted to estimate rate constants using the full information contained in the $p(\mathsf{specific})$ probabilities, so we did not simply threshold $p(\mathsf{specific})$ for this analysis.  Instead, from each single-AOI $p(\mathsf{specific})$ time record we constructed a family of binary time records (\FIG{kinetic_analysis}B, black) by Monte Carlo sampling according to the  $p(\mathsf{specific})$ time series. Each family member has well-defined target-specific binder-present and binder-absent intervals $\Delta t_\mathsf{on}$ and $\Delta t_\mathsf{off}$, respectively. Each of these time records was then analyzed with a two-state hidden Markov model (HMM) (see Materials and Methods), producing a distribution of inferred rate constants from which we calculated mean values and their uncertainties (\FIG{kinetic_analysis}C,D). Comparison of the simulated and inferred values shows that both $k_\mathsf{on}$ and $k_\mathsf{off}$ rate constants are accurate within 30\% at nonspecific binding densities typical of experimental data ($\lambda \leq$ 0.5). At higher nonspecific binding densities, rare interruptions caused by false-positive and false-negative spot detection shorten $\Delta t_\mathsf{on}$ and $\Delta t_\mathsf{off}$ distributions, leading to moderate systematic overestimation of the association and dissociation rate constants.

From the same simulated data we calculated the equilibrium constant $K_\mathsf{eq}$ and its uncertainty. This calculation does not require a time-dependent model and can be obtained directly from the posterior distribution of the average specific-binding probability $\pi$. The estimated equilibrium constants are highly accurate even at excessively high values of $\lambda$ (\FIG{kinetic_analysis}E).  The high accuracy results from the fact that equilibrium constant measurements in general are much less affected than kinetic measurements by occasional false positives and false negatives in spot detection. 

The forgoing analysis shows that Tapqir can accurately recover kinetic and thermodynamic constants from simulated CoSMoS data.  However, experimental CoSMoS data sets can be more diverse.  In addition to having different SNR and non-specific binding frequency values, they also may have non-idealities in spot shape (caused by optical aberrations) and in noise (caused by molecular diffusion in and out of the TIRF evanescent field).  In order to see if Tapqir analysis is robust to these and other properties of real experimental data, we analyzed several CoSMoS data sets taken from different experimental projects. Analysis of each data set took a few hours of computation time on a GPU-equipped desktop computer or cloud computing service (\TABLE{datasets}). We first visualized the results as probabilistic rastergrams (\FIG{experimental_data}A, \FIGSUPP[experimental_data]{DatasetA}A, \FIGSUPP[experimental_data]{DatasetC}A, and \FIGSUPP[experimental_data]{DatasetD}A), in which each horizontal line represents the time record from a single AOI.  Unlike the binary spot/no-spot rastergrams in previous studies (e.g., \cite{Friedman2013-sf,Rosen2020-zn}) we plotted the Tapqir-calculated spot probability $p(\mathsf{specific})$ using a color scale.  This representation allows a more nuanced understanding of the data.  For example, \FIG{experimental_data}A reveals that while the long-duration spot detection events typically are assigned a high probability (yellow), some of the shortest duration events have an intermediate $p(\mathsf{specific})$ (green) indicating that the assignment of these as target-specific is uncertain.  

\include{figures/kinetic_analysis}

To demonstrate the utility of Tapqir for kinetic analysis of real experimental data, we measured binder association rate constants in previously published experimental data sets (\TABLE{datasets}).  We employed our previous strategy  \citep{Friedman2012-if,Friedman2015-nx} of analyzing the duration of the binder-absent intervals that preceded the first binding event.  Such time-to-first binding analysis improves the accuracy of association rate constant estimates relative to those obtained by analyzing all $\Delta t_\mathsf{off}$ values by minimizing the effects of target molecules occupied by photobleached binders, dye blinking and false negative dropouts that occur within a continuous binder dwell interval.  To perform a time-to-first-binding analysis using Tapqir, we used the posterior sampling method (as in \FIG{kinetic_analysis}B, black records) to determine the initial $\Delta t_\mathsf{off}$ in each AOI record. These data were fit to a kinetic model \citep{Friedman2012-if,Friedman2015-nx} in which only a fraction of target molecules $A_\mathsf{f}$ were binding competent and which includes both exponential target-specific association with rate constant $k_\mathsf{a}$, as well as exponential non-specific association with rate constant $k_\mathsf{ns}$ (\FIG{experimental_data}B, \FIGSUPP[experimental_data]{DatasetA}B, \FIGSUPP[experimental_data]{DatasetC}B, and \FIGSUPP[experimental_data]{DatasetD}B).  The Tapqir-derived fits showed excellent agreement with the kinetic model.  

To further assess the utility of the Tapqir method, we used experimental data sets and compared the Tapqir association kinetics results with those from the previously published empirical binary ``spot-picker'' method \citep{Friedman2015-nx} (\FIG{experimental_data}C, \FIGSUPP[experimental_data]{DatasetA}C, \FIGSUPP[experimental_data]{DatasetC}C, and \FIGSUPP[experimental_data]{DatasetD}C). The values of the association rate constant $k_\mathsf{a}$ obtained using these two methods are in good agreement with each other (\FIG{experimental_data}D, \FIGSUPP[experimental_data]{DatasetA}D, \FIGSUPP[experimental_data]{DatasetC}D, and \FIGSUPP[experimental_data]{DatasetD}D). We emphasize that while Tapqir is fully objective, achieving these results with the spot-picker method required optimization by subjective adjustment of spot detection thresholds.  We noted some differences between the two methods in the non-specific association rate constants $k_\mathsf{ns}$. Differences are expected because these parameters are defined differently in the different non-specific binding models used in Tapqir and  spot-picker (see Materials and Methods).

\include{figures/experimental_data}

\input{tables/datasets}

\input{tables/aoisize}