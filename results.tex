\section*{Results}
\paragraph{Data analysis pipeline.} % Figure 1B,C,D
The initial steps in CoSMoS data analysis involve preprocesssing the data set (Fig.~1b) to map the spatial relationship between target and binder images, correct for microscope drift (if any) and list the locations of target molecules. Software packages that perform these preprocessing steps are widely available \cite{Friedman2015-nx, Smith2019-yb}.

The input into Tapqir consists of the time sequence of images (Fig. 1b, right). For colocalization analysis, it is sufficient to consider the image area local to the target molecule. This analyzed area of interest (AOI) needs to be several times the diameter of a diffraction-limited spot to include both the spot and the surrounding background (Fig. 1c). 

In addition to AOIs centered at target molecules, it is useful to also select negative control AOIs from randomly selected sites at which no target molecule is present (Fig. 1b,d). In Tapqir, such off-target control data is analyzed jointly with on-target data and serves to estimate the background level of target-nonspecific binding. 

Once provided with the preprocessing data and image sequence, Tapqir computes for each frame of each AOI the  probability, $p(\mathsf{specific})$, that a target-specific fluorescence spot is present.   The $p(\mathsf{specific})$ values that are output are subsequently used to extract information about the kinetics and thermodynamics of the target-binder interaction.

\paragraph{Bayesian image classification analysis.}
Tapqir calculates $p(\mathsf{specific})$ values using an objective image classification method built on a rigorous Bayesian statistical approach to the CoSMoS image analysis problem. The Bayesian approach has three components. First, we define a probabilistic model of the CoSMoS images. The probabilistic model is a mathematical formalism that describes the AOI images in terms of a set of parameter values.  The model is probabilistic in that each parameter is specified to have a probability distribution that defines the likelihood that it can take on particular values. Model parameters describe physically realistic image features such as photon shot-noise. Second, Tapqir specifies prior distributions for the parameters of the model. These priors embed pre-existing knowledge about the CoSMoS experiment, such as the fact that target-specific spots will be close to the target molecule locations. Third, we infer the values of the model parameters, including $p(\mathsf{specific})$, using Bayes' rule \cite{Bishop2006-oa}. The Tapqir analysis is “time-independent”, meaning that we ignore the time dimension of the recording -- the order of the images does not affect the results.

%, as each image is considered statistically independent of the others. 

\paragraph{Probabilistic image model and parameters.} % Figure 2A,B,C
A single AOI image from a CoSMoS data set is a matrix of noisy pixel intensity values.  In each image, multiple binder molecule fluorescence spots can be present. Fig.~2a shows an example image where two spots are present; one spot is located near the target molecule at the center of the image and another is off-target. 

The probabilistic model mathematically generates images $D$ as follows.  We construct a noise-free AOI image $\mu^I$ as a constant average background intensity $b$ summed with fluorescence spots modeled as 2-D Gaussians $\mu^S$, which accurately approximate the microscope point spread function \cite{Zhang2007-rb} (Fig. 2b). Each 2-D Gaussian is described by parameters integrated intensity $h$, width $w$, and position ($x$, $y$) relative to target molecule position ($x_c$, $y_c$). We define $K$ as the maximum number of spots that can be present in a single AOI image.  For the data we typically encounter, $K = 2$. Since the spots may be present or not in a particular image, we define the $K = 2$ binary indicators $m_{\mathsf{spot}(1)}$ and $m_{\mathsf{spot}(2)}$.  Each indicator can take a value of either 0 denoting spot absence or 1 denoting spot presence. 

The resulting mixture model has four possible combinations for $m_{\mathsf{spot}(1)}$ and $m_{\mathsf{spot}(2)}$: (1) a no-spot image that contains only background (Fig. 2b, top left), (2) a single-spot image that contains the first binder molecule spot superimposed on background (Fig. 2b, bottom left), (3) a single-spot image that contains the second binder molecule spot superimposed on background (Fig. 2b, top right), and (4) a two-spot image that contains both binder molecule spots superimposed on background (Fig. 2b, bottom right).

Among the spots that are present in an AOI image, by assumption at most only one can be target-specific. We introduce the index parameter $\theta$ which identifies the target-specific spot  when it is present (Fig. 2c, middle and right) and equals zero when it is absent (Fig. 2c, left). Since the off-target control AOIs by definition contain only non-specific binding, $\theta = 0$ for all off-target images. 

Finally, to construct realistic noisy images $D$ from the noise-free AOI images $\mu^I$, the model adds intensity-dependent noise to each pixel.  Each measured pixel intensity in a single-molecule fluorescence image has a noise contribution from photon counting (shot noise) and can also contain additional noise arising from electronic amplification \cite{Van_Vliet1998-jk}. The result is a characteristic linear relationship between the noise variance and mean intensity with slope defining the image gain $g$. This relationship is used to compute the random pixel noise values used in the model (see Methods).

The resulting probabilistic image model can be interpreted as a generative process that produces the observed image data $D$. A graphical representation of the probabilistic relationships in the model is shown in Fig. 2d (see also Extended Data Fig. 1a and Methods Algorithm 1). A complete description of the model is given in Methods.  

\paragraph{Parameter prior distributions.}
Specifying prior probability distributions for model parameters is essential for Bayesian analysis and allows us to incorporate pre-existing knowledge about the experimental design. For most model parameters, there is no strong prior information so we use uninformative prior distributions (see Methods). However, we have strong expectations for the positions of specific and non-specific binder molecules that can be expressed as prior distributions and used effectively to discriminate between the two. Non-specific binding can occur anywhere on the surface with equal probability and thus has a uniform prior distribution across the AOI image. Target-specific binding, on the other hand, is colocalized with the target molecule and thus has a prior distribution peaked at the AOI center (Extended Data Fig. 1b). The width of the prior distribution for specific binding location, proximity parameter $\sigma^{xy}$, depends on multiple experiment characteristics such as the spot localization accuracy and the mapping accuracy between target and binder imaging channels. Prior distributions for parameters $\theta$ and $m$ are defined in terms of the average number of target-specific and target non-specific spots per AOI image, $\pi$ and $\lambda$, respectively. To allow convenient use of the algorithm, we infer values of $\sigma^{xy}$, $\pi$, and $\lambda$ appropriate to a given data set using a hierarchical Bayesian analysis (see Methods and Extended Data Fig. 1a).

\paragraph{Bayesian inference and implementation.}
Tapqir calculates posterior distributions of model parameters conditioned on the observed data by using Bayes' theorem. In particular, Tapqir approximates posterior distributions using a variational inference approach implemented in Pyro \cite{Bingham2019-qy}.  Complete details of the implementation are given in the Methods section.

\paragraph{Tapqir analysis output.} % Figure 3A, B
To test the approach, we used Tapqir to analyze simulated CoSMoS image data with a high SNR of 3.76 as well as data from the experiment shown in Fig. 1, which has a lower SNR of 1.61. The simulated data were generated using the same model that was used for analysis (Fig. 2d). Tapqir correctly detects and locates fluorescent spots in the images both for simulated and experimental data (compare ``AOI images'' and ``Spot-detection'' rows in Fig. 3a and 3b, respectively). When a spot is present, corresponding to a high $p(m)$ (e.g., spot 1 (blue) in frame 630 in Fig. 3b) it also has a high intensity $h$ and a comparatively small uncertainty in position coordinates $x$ and $y$. In contrast, when the spot is absent (e.g., both spots 1 and 2 in frame 105 in Fig. 3a) it has a near zero intensity and high uncertainty in position because no spot can be localized. The program also determines the background intensity $b$ for each image without requiring a separate measurement. 

For a spot to be classified as target-specific in addition to having high intensity the spot needs to be colocalized with the target molecule. For example, spot 1 in frame 110 of Fig. 3a and spot 1 in frame 633 of Fig. 3b both have high probabilities of being target-specific, $p(\theta_{\mathsf{AOI}(1), \mathsf{frame}(110)}=1) = 0.99$ and $p(\theta_{\mathsf{AOI}(1), \mathsf{frame}(633)}=1) = 0.99$, respectively. On the other hand, spot 1 in frame 108 of Fig. 3a and spot 2 in frame 635 of Fig. 3b have low probabilities of being target-specific, $p(\theta_{\mathsf{AOI}(1), \mathsf{frame}(108)}=1) = 0.01$ and $p(\theta_{\mathsf{AOI}(1), \mathsf{frame}(635)}=2) = 0.01$, respectively. The probability  $p(\mathsf{specific})$ of there being any target-specific spot in an AOI image is trivially obtained as $p(\mathsf{specific}) = p(\theta > 0)$.   

%\subsection*{Validation with posterior sampling}
% Figure 4

\paragraph{Tapqir fits experimental data well.}
Next, we evaluated how well the model fits experimental data. To accomplish this, we analyzed multiple experimental data sets with different physical characteristics (Extended Data Table 1) and then sampled AOI images from the posterior distributions of parameters (a method known as posterior predictive checking) \cite{Gelman_undated-ro}. The posterior predictive simulations accurately reproduce the experimental AOI appearances, recapitulating the noise characteristics and the numbers, intensities, shapes, and locations of spots (Fig. 4).  The distributions of pixel intensities across the AOI are also closely reproduced (Fig. 4, histograms) confirming that the noise model is accurate. Taken together, these results confirm that the model is rich enough to accurately capture the full range of image characteristics from CoSMoS data sets taken over different experimental conditions.

\paragraph{Tapqir performance.}
Next, we evaluated Tapqir's ability to reliably infer the values of global model parameters. To  accomplish this, we generated simulated data sets  using  a wide range of randomized parameter values and then fit the simulated data to the model (Supplementary Data 2). Fit results show that global model parameters (i.e., average specific spot probability $\pi$, nonspecific binding rate $\lambda$, proximity $\sigma^{xy}$, and gain $g$) are close to the simulated values  (Extended Data Fig. 2 and Supplementary Data 2). This suggests that CoSMoS data contains enough information to reliably infer global model parameters and that the model is not obviously overparameterized.

\paragraph{Tapqir classification accuracy.} Having tested the basic function of the algorithm, we next turned to the key question of how accurately Tapqir detects target-specific spots in increasingly difficult data sets with either decreasing SNR or with increasing frequencies of target-nonspecific binding.  

First, we examined how the accuracy of target-specific spot detection varies with  image SNR using simulated data sets (Supplementary Data 3). By eye, spots can be readily discerned at $\mathrm{SNR}>1$ but cannot be clearly seen at $\mathrm{SNR}<1$ (Fig. 5a). Tapqir gives similar or better performance:  if an image is known to contain a target-specific spot, Tapqir assigns it target-specific spot probability $p(\mathsf{specific})$ which is on average close to  one when $\mathrm{SNR}>1$ (Fig. 5b).  This value sharply decreases below SNR 1, consistent with the subjective impression that no spot is seen under those conditions.  Specifically, the images that contain a target-specific spot (Fig. 5c, green) are almost always assigned a high $p(\mathsf{specific})$ for high SNR data and almost always assigned low $p(\mathsf{specific})$ for low SNR data.  At $\mathrm{SNR} \simeq 1$, these images are assigned a broad distribution of $p(\mathsf{specific})$, accurately reflecting the uncertainty in classifying such data.  Just as importantly, images with no target-specific spot are almost always assigned $p(\mathsf{specific}) < 0.5$ correctly reflecting the absence of the spot (Fig. 5c, gray).

% To test our method we have done the performance comparison between the Bayesian method and the heuristic spot thresholding method (which represents the current state-of-the-art in published CoSMoS analysis methods) on images from experimental data recordings were analyzed. The experiments were designed to produce data sets with a range of SNR in a controlled manner and with know true identity of the images as described in Methods.

% Spot detection is performed in a probabilistic manner. Spot existence probability depends on the information in the entire image. However, it primarily correlates with the intensity of the spot. Discrimination of spots from random fluctuations in the background signal depends on the prior and not on the threshold parameter. In the absence of prior information uninformative prior can be used. Plotting results show that with half normal prior spots have to be roughly above 1 SNR.

Ideally, we want to correctly identify target-specific binding when it occurs but also avoid identifying target-specific binding when it does not occur. To quantify Tapqir's classification accuracy, we next examined binary image classification statistics. We thresholded $p(\mathsf{specific})$ at $0.5$ and calculated three statistics: \textit{recall}, \textit{precision}, and the Matthews Correlation Coefficient (MCC) \cite{Matthews1975-rw} (Fig. 5d; see Methods). \textit{Recall} is defined as the fraction of target-specific spots that are correctly predicted. Recall is high at high SNR and decreases at lower SNR. Recall plot is a binary version of the plot in Fig. 5b and as expected has a similar shape. \textit{Precision} is the fraction of all predicted target-specific spots that are correct. Precision is near one at all SNR values tested; this shows that the algorithm rarely misclassifies an image as containing a target-specific spot when none is present. At the lowest SNR value (0.38) none of the images are assigned $p(\mathsf{specific})$ $>$ 0.5 (Fig. 5c, leftmost panel). The MCC is a single value that compares whether or not a target-specific spot is predicted by Tapqir vs. whether or not a target-specific spot is actually present in the simulated data.  The MCC is equivalent to the Pearson correlation coefficient between the predicted and true classifications, giving 1 for a perfect match, 0 for a random match, and $-1$ for complete disagreement. The MCC results suggests that the overall performance of Tapqir is excellent at SNR $\ge 1$: the program rarely misses target-specific spots that are in reality present and rarely falsely reports a target-specific spot when none is present.  

% Each data set was analyzed by both the Bayesian method and the heuristic spot thresholding algorithm (Figure \ref{fig:real_data}). By comparison with the known ``true'' identities of the images, the accuracy of the resulting classifications was judged using a variety of specialized statistics for binary classification data, including Recall (also known as True Positive Rate and Sensitivity), Precision, and the Matthews Correlation Coefficient (MCC) \citep{Fawcett2006-bq, Matthews1975-rw}. The MCC statistic is widely regarded as a single overall, balanced measure which is meaningful even when the classes are of very different sizes. The MCC corresponds to the Pearson correlation coefficient between the estimated and “true” binary classifications. MCC=+1 represents a perfect prediction, MCC=0 a perfectly random prediction, and MCC=-1 indicates maximal disagreement between truth and estimation. Over a range of SNR, the Bayesian method gave image classification accuracy (as quantified by the MCC) better than the heuristic spot thresholding algorithm.

The forgoing analyses (Fig. 5b-d) examined Tapqir performance on data in which the rate of target-nonspecific binding was moderate ($\lambda  = 0.15$ non-specific spots per image on average).  We next examined the effects of increasing the non-specific rate.  Specifically, we used  simulated data (Supplementary Data 1) with $\textrm{SNR} = 3.76$ to test the classification accuracy of Tapqir at different non-specific binding rates up to $\lambda  = 1$ non-specifically bound molecule per image on average, a rate considerably higher than typical in experimental data (compare experimental data sets in Extended Data Table 1).  Even at the highest $\lambda$,  Tapqir accurately identified target-specific spots (Fig. 5e,f) and returned excellent binary classification statistics (Fig.~5g).  At the highest non-specific spot rates, a few images with target-specific spots are classified as not having a specific spot ($p(\mathsf{specific})$ near zero) or as being ambiguous ($p(\mathsf{specific})$ near 0.5) (Fig. 5f, green bars). Similarly, a few images with target-nonspecific spots are classified as having specific spot ($p(\mathsf{specific})$ near or above 0.5) which only occurs at the highest $\lambda$ (Fig. 5f, gray bars).

We also tested the opposite extreme by simulating data sets with no target-specific binding at both low and high non-specific binding rates (Supplementary Data 4). Analysis of such data  (Fig. 5h) shows that no target-specific binding ($p(\mathsf{specific}) > 0.5$) was detected even under the highest non-specific binding rate, demonstrating that Tapqir is robust to false-positive target-specific spot detection even under these extreme conditions. 

\paragraph{Kinetic and thermodynamic analysis.}
The most widespread application of CoSMoS experiments is to measure rate and equilibrium constants for the interaction of the target and binder molecules being studied.  We next tested whether these constants can be accurately determined using Tapqir-calculated posterior parameters. 

We first simulated CoSMoS data sets (Supplementary Data 5) that reproduced the behavior of a one-step association/dissociation reaction mechanism (Fig. 6a). Simulated data (e.g., Fig. 6b, purple) were analyzed with Tapqir.   As discussed previously, an advantage of Tapqir is that, unlike current CoSMoS data analysis methods, it accounts for the reliability of the data by giving the posterior probability $p(\mathsf{specific})$ of a target-specific spot in each image (e.g., Fig. 6b, green) rather than merely producing a binary spot/no-spot output.  We use the posterior probability time series in kinetic analysis by employing a Monte Carlo sampling method that naturally provides both typical values and uncertainties of the kinetic rate constants.  In particular, we sample a family of binary data records (Fig. 6b, black) from $p(\mathsf{specific})$, each of which has well-defined target-specific binder-present and binder-absent intervals $\Delta t_\mathrm{on}$ and $\Delta t_\mathrm{off}$,  respectively. These intervals are then fit to exponential functions (see Methods) to determine both the values and the uncertainties (i.e., standard errors) of $k_\mathrm{on}$ and $k_\mathrm{off}$ (Fig.~6c,d). Comparison of the simulated and estimated values shows that both rate constants are accurate within 30\% at nonspecific binding rates typical of experimental data ($\lambda \leq 0.5$). At higher nonspecific binding rates, rare interruptions caused by false-positive and false-negative spot detections shorten $\Delta t_\mathrm{on}$ and $\Delta t_\mathrm{off}$ distributions, leading to moderate systematic overestimation of the association and dissociation rate constants.

We used the same simulations to estimate the equilibrium dissociation constant $K_\mathrm{eq} = k_\mathrm{on}/k_\mathrm{off}$.  Calculation of the equilibrium constant and its uncertainty does not require a time-dependent model and can be obtained directly from the posterior distribution of the average specific-binding probability $\pi$. The estimated equilibrium constants are highly accurate even at excessively  high values of $\lambda$ (Fig. 6e).  The high accuracy results from the fact that equilibrium constant measurements are much less affected than kinetic measurements by occasional errors in spot detection. 

% Figure 7
Experimental CoSMoS data sets are diverse.  In addition to having different SNR and non-specific binding frequency values, they also may have non-idealities in spot shape caused by optical aberrations and in noise caused by molecular diffusion in and out of the TIRF evanescent field.  In order to see if Tapqir analysis is robust to these and other properties of real experimental data, we  analyzed several CoSMoS data sets taken from different experimental projects (Extended Data Table 1, Fig. 7, Extended Data Fig. 3 and 4). We first visualized the results as rastergrams (Fig. 7a, Extended Data Fig. 3a and 4a), in which each horizontal line represents the time record from a single AOI.  Unlike the binary spot/no-spot rastergrams in previous studies \cite{Friedman2013-sf,Rosen2020-zn} we plotted the Tapqir-calculated spot probability $p(\mathsf{specific})$ using a color scale.  This representation allows a more nuanced understanding of the data.  For example, Fig. 7a reveals that while the long-duration spot detection events typically are assigned a high probability (yellow), some of the shortest duration events have an intermediate $p(\mathsf{specific})$ (green) indicating that the assignment of these as target-specific is uncertain.  

To demonstrate the utility of Tapqir for kinetic analysis of experimental data sets, we analyzed the duration of the binder-absent intervals that preceded the first binding event.  Such time-to-first binding analysis improves accuracy by minimizing the effect of target molecules occupied by photobleached binders, dye blinking and the effect from false negative dropouts that occur within a continuous binder dwell interval \cite{Friedman2006-kb}.  Specifically, the analysis used the Monte Carlo posterior sampling method (as in Figure 6b, black records) to determine the initial  $\Delta t_\mathrm{off}$ in each record and then fit the distribution of these values to calculate the target-specific association rate constant $k_\mathrm{a}$, as well as the non-specific association rate $k_\mathrm{ns}$ and the active fraction of target molecules $A_\mathrm{f}$ (Fig. 7b, Extended Data Fig. 3b and 4b). Comparison to the results of a previously published method that analyzes images using an empirical binary spot-picking method \cite{Friedman2006-kb} (Fig. 7c, Extended Data Fig. 3c and 4c) shows that values of parameters obtained using these two methods are in reasonable agreement with each other. We emphasize that results obtained by Tapqir and the spot-picker method are not expected to agree exactly since they are based on different models.  For example, Tapqir accounts for the possibility that target-non specific and target-specific spots can be present simultaneously in the same image, and is based on a specific model of image noise.  Tapqir provides information about the reliability of the spot classification in each image and does so without manual fine-tuning of analysis parameters for different data sets, allowing reliable determination of molecular kinetic and thermodynamic properties.

