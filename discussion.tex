\section*{Discussion}

We here describe an algorithm and computer software, Tapqir, for rigorous statistical classification and analysis of image data from single-molecule fluorescence co-localization experiments. The approach is distinct from existing methods in multiple ways that convey important advantages for the accuracy and robustness of CoSMoS data analysis: 1) it uses a global model that captures all the important physical aspects of CoSMoS data generation in a single unified framework, 2) it employs Bayesian inference, incorporating appropriate levels of prior knowledge for all model parameters, 3) it produces spot probability estimates that can be used to inform downstream kinetic and thermodynamic analyses, and 4) it is implemented in a probabilistic programming language that facilitates enhancement, modification, and analysis of the model. Tapqir performs as well as or better than  existing high-quality CoSMoS data analysis methods. It achieves this performance automatically, without requiring the subjective tuning of analysis parameters that makes effective use of other methods challenging to non-expert users.
%also: off-target handling is different

% probabilistic modeling
A broad range of physical processes contribute to the formation of CoSMoS images. These include camera and photon noise, target-specific and non-specific binding, and time- and position-dependent variability in fluorophore imaging and image background. Unlike prior CoSMoS analysis methods, Tapqir considers these aspects of imaging in a single model that includes all model parameters and simultaneously jointly analyzes on-target and off-target control data.  This approach integrates data analysis and interpretation that would otherwise be conducted in separate sequential steps, leading to loss of information about uncertainties at each step of the analysis. Importantly, the model includes the possibility of multiple binder molecule fluorescence spots being present in the vicinity of the target, including both target-specific binding and target-nonspecific interactions of binder molecules with the surface. Explicit modeling of target-nonspecific spots makes it possible to include off-target control data as a part of an experimental data set, all of which is globally fit to a unified model in a single process.  Similarly, all AOIs and frames in the dataset are simultaneously fit to the global model, making the results more accurate while still allowing for frame-to-frame and AOI-to-AOI variability in image formation caused by variations in laser intensity, fluctuations in background, and other non-idealities.

% Bayesian inference
Tapqir employs Bayesian inference of model parameters. The parameters include those of mechanistic interest, such as the average probability of target-specific binding, as well as ``nuisance'' parameters that are not of primary interest but nevertheless essential for image modeling. In previous image-based methods for CoSMoS analysis  \cite{Friedman2015-nx,Smith2019-yb}, nuisance parameters were either determined from separate experiments (e.g., gain is determined from calibration data using the linear relationship between the noise variance and the mean intensity), set as a hyperparameter (e.g., subjective choice of user-set thresholds for spot intensity and proximity in colocalization detection), or determined at a post-processing analysis step (e.g., rate of non-specific binding). In contrast, Tapqir directly learns these parameters from the full set of experimental data, thus eliminating the need for additional experiments, subjective adjustment of hyperparamaters, and post-processing steps.

A key feature of Bayesian analysis is that it allows quantitative specification about the degree of prior knowledge of the values of all model parameters. For some parameters, Tapqir uses relative uninformative priors that provide only weak information about the value of the corresponding parameters.  In these cases, the program mostly infers parameters from the data.  In contrast, some priors are more informative.  Binder molecule spots near the target molecule are more likely to be target-specific rather than target-nonspecific, so we use this known feature of the experiment by encoding the likely position of target-specific binding as a Bayesian prior. This tactic effectively enables statistical classification of spots as either target-specific or target-nonspecific, which would be difficult using other inference methodologies.

Prior work \cite{Smith2019-yb,Smith2015-gf} did not use a Bayesian image classification method.  Instead they used a frequentist hypothesis test (a generalized likelihood ratio test) for spot detection, which lacks the key advantages of the model-based Bayesian analysis used here.

Tapqir predicts target-specific spot presence probabilities $p(\mathsf{specific})$ for each image, rather than Boolean ``spot/no spot'' classification used in prior work. Probabilities provide more nuanced information about spot classification which can be useful for downstream analysis. Even though Tapqir does not explicitly account for kinetic processes, we demonstrate that spot probabilities can be used in determining rate constants (and their uncertainties) of the underlying molecular mechanisms. In this respect, Tapqir provides comparable results to other methods but does so without subjective parameter tweaking and in a manner that quantitatively accounts for the strength of the experimental data.

% probabilistic programming
Tapqir is implemented in Pyro, a Python-based probabilistic programming language (PPL) \cite{Bingham2019-qy}. Probabilistic programming is a relatively new paradigm in which probabilistic models are expressed in a high-level language that allows easy formulation, modification, and automated inference \cite{Van_de_Meent2018-mi}. Design principles and use of GPU-supported backend numeric libraries in modern PPLs such as Pyro enable flexible and expressive probabilistic modeling scalable to large datasets. Scalability is a significant consideration, since the sizes of CoSMoS datasets have increased due to faster, larger cameras \cite{Quan2011-cg}, the availability of fluorescent dyes with dramatically improved photostability \cite{Grimm2015-ea} (ref. JF group, Blanchard) (which increase the amount of data from a single experiment), and microscopes that efficiently collect single-molecule data at more wavelengths simultaneously \cite{Friedman2006-kb}. 

Tapqir and Pyro are open-source software; Tapqir and its documentation are available at \url{https://github.com/gelles-brandeis/tapqir}.

% Keep for cover letter: It is a niche tool used previously by statisticians (refs.) and to some extent in bioinformatics (refs) but has not been widely used to analyze laboratory data in the life sciences. 

%future direction:
In this work we focused on developing an image model for colocalization detection in a relatively simple binder-target single-molecule experiment. However, Tapqir has a flexible framework that can be extended readily to more complex models. For example, we expect Tapqir to naturally extend to multi-state and multi-color analysis. Furthermore, with the development of more efficient sequential hidden Markov modeling algorithms \cite{Sarkka2019-jw,Obermeyer2019-pp} Tapqir can potentially be extended to directly incorporate kinetic processes, allowing direct inference of kinetic mechanisms.

% possible reviewers:  Ruben Gonzales, Jan van de Meent, Chris Wiggins, Taekjip Ha, ?David Grunwald, ?Carlas Smith, ?Aaron Hoskin, Shixin Liu (Rockefeller)
% Possible info for cover letter: Like other recent methods for CoSMoS analysis\cite{Friedman2015-nx,Smith2019-yb}, Tapqir maximizes extraction of useful information from data (particularly at the low S/N inherent to many CoSMoS experiments) by directly analyzing 2-D images as opposed to integrated fluorescence. Like Tapqir, these image analysis based methods can be more accurate than previous approaches in part because they make use of information contained in the 2-D images that are disregarded when only the integrated intensity is used\cite{Friedman2015-nx}. While these methods greatly improve CoSMoS data analysis relative to methods based on integrated fluorescence intensity records, they nevertheless suffer from significant deficiencies. First, current methods require subjective choice of user-set thresholds for spot amplitude, diameter and proximity. These settings significantly affect error rates and no objective method to select them currently exists, making the approach non-robust and overly complicated. Second, it is unsatisfying from a theoretical perspective that existing analysis methods are performed in multiple steps with a loss of information about the uncertainties at each step of the analysis. Spot detection is performed on the extracted features of the spot and not the raw 2-D images themselves. Furthermore, spot detection step produces only a binary output (spot present or absent); they do not output the probability of spot presence in marginal images, a critical feature in the analysis of low S/N data. Kinetic analysis, in turn, is based on the binary output of the spot detection step, further reducing the amount of information transmitted from the raw images. Third, it is nontrivial to incorporate prior knowledge (e.g., co-localization accuracy, size of the spot, frequency of non-specific binding) into these analysis methods.

\begin{comment}

NEW TODO LIST
- Add missing references
- Update Abstract
- Update the style of the table in Fig. 2e
- Update Fig. 6
- Table 1 footnote
- **Posterior predictive checking
- Negative simulations
- Seed simulations
- Revise description of how posterior theta samples are obtained and p(specific) is calculated.

methods experimentl data part
Discussion 
Remake figures with new program 6, 7, 5h, 3,5 update
Spreadsheets (scripts)
Spreadsheet key
literature review
get larry to read

--potentially after submission --
Software (is it required before submission?)
Installation ducomentation
Use documentation
More datasets
Use larry

--on publication --
Data archive

\end{comment}

