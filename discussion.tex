\section{Discussion}

A broad range of physical processes contribute to the formation of CoSMoS images. These include camera and photon noise, target-specific and non-specific binding, and time- and position-dependent variability in fluorophore imaging and image background. Unlike prior CoSMoS analysis methods, Tapqir considers these aspects of imaging in a single, holistic model. The model explicitly includes the uncertainties due to photon noise, camera gain, and spatial variability in intensity offset. The model also includes the possibility of multiple binder molecule fluorescence spots being present in the vicinity of the target, including both target-specific binding and target-nonspecific interactions of binder molecules with the coverslip surface. This explicit modeling of target-nonspecific spots makes it possible to include off-target control data as a part of the experimental data set.  Similarly, all AOIs and frames in the data set are simultaneously fit to the global model in a way that allows for realistic frame-to-frame and AOI-to-AOI variability in image formation caused by variations in laser intensity, fluctuations in background, and other non-idealities. The global analysis based on a single, unified model enables the final results (e.g., kinetic and thermodynamic parameters) to be estimated in a way that is cognizant of all known sources of uncertainty in the data.

Previous approaches to CoSMoS data analysis, including ours \citep{Friedman2015-nx}, did not employ a holistic modeling approach and instead relied on a multi-step process that includes a separate binary classification step.  These prior methods require subjective setting of classification thresholds.  Because they are not fully objective, such methods cannot reliably account for uncertainties in spot classification, which compromises error estimates in the analysis pipeline downstream of spot classification. One recent approach \citep{Smith2019-yb,Smith2015-gf}, which like Tapqir analyzes 2-D images instead of integrated intensities, used a Bayesian kinetic analysis but a frequentist hypothesis test (a generalized likelihood ratio test) for spot detection.  The frequentist method lacks a key advantage of Tapqir's model-based Bayesian approach that here enables prediction of target-specific spot presence probabilities $p(\mathsf{specific})$ for each image, rather than a binary ``spot/no spot'' classification.  In general, previous approaches in essence assume that spot classifications are correct, and thus the uncertainties in the derived molecular properties (e.g., equilibrium constants) are systematically underestimated because the errors in spot classification, which can be large, are not accounted for. By performing a probabilistic spot classification, Tapqir enables reliable inference of molecular properties, such as thermodynamic and kinetic parameters, and allows statistically  well-justified estimation of parameter uncertainties.  This more inclusive error estimation likely accounts for the generally larger kinetic parameter error bars obtained from Tapqir compared to those from the existing spot-picker analysis method (\FIG{experimental_data}, \FIGSUPP[experimental_data]{DatasetA}, \FIGSUPP[experimental_data]{DatasetC}, and \FIGSUPP[experimental_data]{DatasetD}). Even though existing analysis methods take advantage of subjective tuning by a human analyst, our comparisons show that Tapqir performs at least comparably to (\FIG{experimental_data}, \FIGSUPP[experimental_data]{DatasetA}, \FIGSUPP[experimental_data]{DatasetC}, and \FIGSUPP[experimental_data]{DatasetD}) and under some conditions much better than (\FIGSUPP[tapqir_performance]{fn}) the existing spot-picker method.

The Tapqir model includes parameters of mechanistic interest, such as the average probability of target-specific binding, as well as ``nuisance'' parameters that are not of primary interest but nevertheless essential for image modeling. In previous image-based methods for CoSMoS analysis (e.g., \citep{Friedman2015-nx,Smith2019-yb}), nuisance parameters were either measured in separate experiments (e.g., gain was determined from calibration data), set heuristically (e.g., a subjective choice of user-set thresholds for spot intensity and proximity in colocalization detection), or determined at a separate analysis step (e.g., rate of non-specific binding). In contrast, Tapqir directly learns parameters from the full set of experimental data, thus eliminating the need for additional experiments, subjective adjustment of tuning parameters, and post-processing steps.

A key feature of Bayesian analysis is that the extent of prior knowledge of all model parameters is explicitly incorporated. Where appropriate, Tapqir uses relatively uninformative priors that only weakly specify information about the value of the corresponding parameters.  In these cases, the program mostly infers parameter values from the data.  In contrast, some priors are more informative.  For example, binder molecule spots near the target molecule are more likely to be target-specific rather than target-nonspecific, so we use this known feature of the experiment by encoding the likely position of target-specific binding as a Bayesian prior. This tactic effectively enables probabilistic classification of spots as either target-specific or target-nonspecific, which would be difficult using other inference methodologies.

Tapqir is implemented in Pyro, a Python-based probabilistic programming language (PPL) \citep{Bingham2019-qy}. Probabilistic programming is a relatively new paradigm in which probabilistic models are expressed in a high-level language that allows easy formulation, modification, and automated inference \citep{Van_de_Meent2018-mi}. In this work we focused on developing an image model for colocalization detection in a relatively simple binder-target single-molecule experiment. However, Tapqir can be extended readily to more complex models. For example, we expect Tapqir to naturally extend to multi-state and multi-color analysis. Furthermore, with the development of more efficient sequential hidden Markov modeling algorithms \citep{Sarkka2019-jw,Obermeyer2019-pp} Tapqir can potentially be extended to directly incorporate kinetic processes, allowing direct inference of kinetic mechanisms.

Tapqir and Pyro are free, open-source software; Tapqir and its documentation are available at \url{https://github.com/xxxx}
%gelles-brandeis/tapqir}.