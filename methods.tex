\section*{Methods}

\subsection*{The Tapqir model} 

Our intent is to model CoSMoS image data by accounting for the most significant physical aspects of the image generation process, such as a realistic description of photon noise and binding of target-specific and target-nonspecific molecules to the microscope slide surface. An extended version of the graphical representation of the model for CoSMoS data that includes probability distributions is shown in Extended Data Fig. 1a. The corresponding generative model represented as pseudocode is shown in Algorithm 2. Below we describe the model in detail starting with the observed data and the likelihood function and then proceed with model parameters and their prior distributions.

\paragraph{Tapqir data.} Raw input data into Tapqir consists of $W \times H$ binder channel images ($D^\mathsf{raw}$) for each time frame (Fig. 1b, right) and the list of drift-corrected locations of target molecules within the raw images ($x^{\mathsf{target}, \mathsf{raw}}$, $y^{\mathsf{target}, \mathsf{raw}}$). Tapqir selects $P \times P$ area around each target molecule (AOI) and returns the new data set $D$ consisting of a set of $P \times P$ grayscale images, collected at $N$ number of AOI sites for a range of $F$ number of frames (Fig.1 c,d) (Algorithm 1). Images are centered with pixel resolution at new locations of target molecules ($x^\mathsf{target}$, $y^\mathsf{target}$) where $x^\mathsf{target}$ and $y^\mathsf{target}$ are both within the $(P/2-1,P/2)$ central range of the image. Cartesian pixel indices ($i$, $j$) represent the center point of a pixel on the image plane. While experimental intensity measurements are integers, we treat them as continuous values in our analysis.

\input{preprocessing}

\paragraph{Image likelihood.} We model the image data $D$ as the sum of a photon-independent offset $\delta$ introduced by the camera and the noisy photon-dependent pixel intensity values $I$:
%
\begin{equation}
    D = \delta + I
\end{equation}

In our model, each pixel in the photon-dependent image $I$ has a  variance which is equal to  the mean intensity $\mu^I$ of that pixel multiplied by the gain $g$. This formulation accounts for both photon shot noise and additional noise introduced by EMCCD camera amplification \cite{Van_Vliet1998-jk} and is expressed using a continuous Gamma distribution:
%
\begin{equation}
    I \sim \mathbf{Gamma} (\mu^I, \sqrt{\mu^I \cdot g})
\end{equation}

The Gamma distribution here is parameterized by its mean and standard deviation. The parameterization of the Gamma distribution and all other distributions we use in this work is given in Extended Data Table 3.

\paragraph{Image model.} The idealized noise-free image $\mu^I$ is represented  as the sum of a background intensity $b$ and the intensities from fluorescence spots modeled as  2-D Gaussians $\mu^S$:
%
\begin{equation}
    \mu^I = b + \sum_{\mathsf{spot}} \mu^S
\end{equation}

\noindent
For simplicity we allow at most $K$ number of spots in each frame of each AOI.  (In this article, we always use $K$ equal to 2.)  The presence of a given spot in the image is encoded in the binary spot existence parameter $m$, where $m = 1$ when the corresponding spot is present and $m = 0$ when it is absent.

The intensities for a 2-D Gaussian spot at each pixel coordinate ($i$, $j$) is given by:
%
\begin{equation}
    \mu^S_{\mathsf{pixelX}(i), \mathsf{pixelY}(j)} = \dfrac{m \cdot h}{2 \pi w^2} \exp{\left( -\dfrac{(i-x-x^\mathsf{target})^2 + (j-y-y^\mathsf{target})^2}{2 w^2} \right)}
\end{equation}

\noindent
with spot parameters total integrated intensity $h$, width $w$, and center ($x$, $y$) relative to the target molecule located at ($x^\mathsf{target}$, $y^\mathsf{target}$). 
%

To discriminate between spots from target-specific and target-nonspecific binding, we use the index parameter $\theta$ which ranges from $0$ to $K$. $\theta$ specifies the index of the target-specific spot when it is present with zero meaning no target-specific spot is present. For off-target control data $\theta$ is always set to zero.
%

\paragraph{Prior distributions.} The prior distributions for the model parameters are detailed below and illustrated in Extended Data Fig. 1a. Unless otherwise indicated we assume largely uninformative priors (such as the Half-Normal distribution with large mean). Parameters of prior distributions can be changed if necessary.

Background intensity $b$ follows a Gamma distribution:
%
\begin{equation}
    b \sim \mathbf{Gamma}(\mu^b, \sigma^b)
\end{equation}

\noindent
where the mean $\mu^b \in \mathbb{R}_{>0}^{\mathsf{AOI}[N]}$ and standard deviation $\sigma^b \in \mathbb{R}_{>0}^{\mathsf{AOI}[N]}$ of the background intensity describe the irregularity in the background intensity in time and across the field of view of the microscope. Hyperpriors for $\mu^b$ and $\sigma^b$ are uninformative:
%
\begin{subequations}
\begin{align}
    \mu^b &\sim \mathbf{HalfNormal}(1000) \\
    \sigma^b &\sim \mathbf{HalfNormal}(100)
\end{align}
\end{subequations}
%
The prior distribution for the index of the target-specific spot $\theta$ is modeled hierarchically in terms of the average specific binding probability $\pi \in [0, 1] $. The probability that $\theta = 0$ is equal to the probability of no specifically bound spot being present (i.e., $1-\pi$). Since spot indices are arbitrarily assigned, the probability that the specifically bound molecule is present is equally split between those indices (i.e., $\frac{\pi}{K}$). We represent the prior for $\theta$ as a Categorical distribution of the following form
%
\begin{equation}
    \theta \sim \mathbf{Categorical}\left(1 - \pi, \frac{\pi}{K}, \dots, \frac{\pi}{K}\right)
\end{equation}

The average target-specific binding probability $\pi$ has an uninformative Jeffreys prior given by a Beta distribution
%
\begin{equation}
    \pi \sim \mathbf{Beta}(1/2, 1/2)
\end{equation}

The prior distribution for the spot presence indicator $m$ is conditional on $\theta$. When $\theta$ corresponds to spot index $k$, i.e., $\theta = k$, then $m_{\mathsf{spot}(k)} = 1$. When $\theta$ does not correspond to a spot index $k$, i.e., $\theta \neq k$, then either spot $k$ is target-nonspecific or a spot corresponding to $k$ does not exist. Consequently, for $\theta \neq k$ we assign $m_{\mathsf{spot}(k)}$ to either 0 or 1 with a probability dependent on the non-specific binding rate $\lambda \in \mathbb{R}_{>0}$:
%
\begin{equation}
    m_{\mathsf{spot}(k)} \sim
    \begin{cases}
        \mathbf{Bernoulli}(1) & \text{$\theta = k$} \\
        \mathbf{Bernoulli} \left( \sum_{l=1}^K \dfrac{l \cdot \mathbf{TruncPoisson}(l; \lambda, K)}{K} \right) & \text{$\theta = 0$} \\
        \mathbf{Bernoulli} \left( \sum_{l=1}^{K-1} \dfrac{l \cdot \mathbf{TruncPoisson}(l; \lambda, K-1)}{K-1} \right) & \text{otherwise}
    \end{cases}
\end{equation}

The mean non-specific binding rate $\lambda$ is expected to be much less than two non-specifically bound spots per frame per AOI; therefore, we use an Exponential prior of the form
%
\begin{equation}
    \lambda \sim \mathbf{Exponential}(1)
\end{equation}

The prior distribution for the integrated spot intensity $h$ is chosen to fall off at a value much greater than typical spot intensity values 
%
\begin{equation}
    h \sim \mathbf{HalfNormal}(10000)
\end{equation}

The optimal width $w$ of fluorescence spots in CoSMoS experiments is typically in the range of 1--2 pixels (ref). We use a Uniform prior confined to the range between 0.75 and 2.25 pixels:
%
\begin{equation}
    w \sim \mathbf{Uniform}(0.75, 2.25)
\end{equation}

Priors for spot position ($x$, $y$) depend on whether the spot represents target-specific or non-specific binding. Specifically bound molecules are colocalized with the target molecule with accuracy $\sigma^{xy}$ that is generally less than one pixel and depends on various factors including microscope point-spread function and magnification, accuracy of registration between binder and target channels, and accuracy of drift correction. We use an Affine-Beta prior with zero mean position relative to the target molecule location ($x^\mathsf{target}$, $y^\mathsf{target}$), and a standard deviation parameterized as proximity $\sigma^{xy} $ (Extended Data Fig. 1b, orange). On the other hand, non-specific binding can occur anywhere within the image and therefore has a uniform distribution (Extended Data Fig. 1b, blue).  The range for ($x$, $y$) is constrained to one-half pixel beyond the image region allowing the center of off-target spots to fall up to one-half pixel beyond the AOI boundary. Note, that the Uniform distribution is a special case of the Affine-Beta distribution.
%
\begin{equation}
    x_{\mathsf{spot}(k)}, y_{\mathsf{spot}(k)} \sim
    \begin{cases}
        \mathbf{AffineBeta}\left( 0, \sigma^{xy}, -\dfrac{P+1}{2}, \dfrac{P+1}{2} \right) & \theta = k ~\textrm{(target-specific)} \\
        \mathbf{Uniform}\left(-\dfrac{P+1}{2}, \dfrac{P+1}{2} \right) & \theta \neq k ~\text{(target-nonspecific)}
    \end{cases}
\end{equation}

We give $\sigma^{xy}$ an Exponential prior with a characteristic width of one pixel:
%
\begin{equation}
    \sigma^{xy} \sim \mathbf{Exponential}(1)
\end{equation}

Gain $g$ depends on the settings of the amplifier and electron multiplier (if present) in the camera. It has a positive value and is typically in the range between 5--20. We use a Half-Normal prior with a broad distribution encompassing this range:
%
\begin{equation}
    g \sim \mathbf{HalfNormal}(50)
\end{equation}

The prior distribution for the offset signal $\delta$ is empirically measured from the output of camera sensor regions that are masked from incoming photons. Collected data from these pixels are transformed into a density histogram with step size of $1$. Bin values $\delta_\mathrm{samples}$ and their weights $\delta_\mathrm{weights}$ are used to construct an Empirical prior:
%
\begin{equation}
    \delta \sim \mathbf{Empirical}(\delta_\mathrm{samples}, \delta_\mathrm{weights})
\end{equation}

\input{model}

\subsection*{Joint distribution}

Let $\phi$ be the set of all model parameters. The joint distribution is factorized as:
%
\begin{equation}
\begin{aligned}
    p(D, \phi) =~&p(g) p(\sigma^{xy}) p(\pi) p(\lambda) \prod_{\mathsf{AOI}} \left[ p(\mu^b) p(\sigma^b) \prod_{\mathsf{frame}} \left[ \vphantom{\prod_{F}} p(b | \mu^b, \sigma^b) p(\theta | \pi) \vphantom{\prod_{\substack{\mathsf{pixelX} \\ \mathsf{pixelY}}}} \cdot \right. \right. \\
    &\prod_{\mathsf{spot}} \left[ \vphantom{\prod_{F}} p(m | \theta, \lambda) p(h) p(w) p(x | \sigma^{xy}, \theta) p(y | \sigma^{xy}, \theta) \right] \left. \left. \prod_{\substack{\mathsf{pixelX} \\ \mathsf{pixelY}}} p(\delta) p(D | \mu^I, g, \delta) \right] \right]
\end{aligned}
\end{equation}

\subsection*{Inference}

For a Bayesian analysis, we want to obtain the posterior distribution for parameters $\phi$ given the observed data $D$ using Bayes rule:
%
\begin{equation}
    p(\phi | D) =
    \dfrac{p(D, \phi)}{\int_{\phi} p(D, \phi) d\phi}
\end{equation}

Note that the integral in the denominator of this expression is necessary to calculate the posterior distribution, but it is usually analytically intractable. However, variational inference provides a robust method to approximate the posterior distribution $p(\phi | D)$ with a parameterized variational distribution $q(\phi)$ \cite{Bishop2006-oa}.
%
\begin{equation}
    p(\phi | D) \simeq q(\phi)
\end{equation}

For a better convergence, we first run inference with ($\sum_\theta p(D, \phi)$, $q(\phi \setminus \theta)$) pair where $\theta$ is marginalized out in the model \cite{Obermeyer2019-xt}. The variational distribution $q(\phi \setminus \theta)$ has the following factorization:
%
\begin{equation}
\begin{aligned}
    q(\phi \setminus \theta) =~&q(g) q(\sigma^{xy}) q(\pi) q(\lambda) \cdot \\
    &\prod_{\mathsf{AOI}} \left[ q(\mu^b) q(\sigma^b) \prod_{\mathsf{frame}} \left[ \vphantom{\prod_{F}} q(b) \prod_{\mathsf{spot}} \left[ \vphantom{\prod_{F}} q(m) q(h | m) q(w | m) q(x | m) q(y | m) \right] \prod_{\substack{\mathsf{pixelX} \\ \mathsf{pixelY}}} q(\delta) \right] \right]
\end{aligned}
\end{equation}

To obtain $q(\theta)$ we then run inference with full model using ($p(D, \phi)$, $q(\phi)$) pair with already learned good variational parameters being fixed. $q(\phi)$ has the following factorization:

\begin{equation}
\begin{aligned}
    q(\phi) =~&q(g) q(\sigma^{xy}) q(\pi) q(\lambda) \cdot \\
    &\prod_{\mathsf{AOI}} \left[ q(\mu^b) q(\sigma^b) \prod_{\mathsf{frame}} \left[ q(b) q(\theta) \prod_{\mathsf{spot}} \left[ \vphantom{\prod_{F}} q(m | \theta) q(h | m) q(w | m) q(x | m) q(y | m) \right] \prod_{\substack{\mathsf{pixelX} \\ \mathsf{pixelY}}} q(\delta) \right] \right]
\end{aligned}
\end{equation}

\subsubsection*{Variational distribution specification}

In order to apply variational inference, we must specify the parametric form of the variational distribution $q(\phi)$
that we use as an approximation to the true posterior distribution $p(\phi | D)$.

Below we list variational distributions, variational parameters and the domains of variational parameters. Variational inference procedure is prone to get stuck in local maxima and is heavily affected by initial values of variational parameters. Below we also provide the initial values of variational parameters that worked well in our analysis.

\input{guide}

\subsection*{Implementation}

The model and variational inference method outlined above are implemented as a probabilistic program in the Python-based probabilistic programming language (PPL) Pyro \cite{Foerster2018-kd,Bingham2019-qy,Obermeyer2019-xt}. The objective that is being optimized is the evidence lower bound (ELBO) estimator that provides unbiased gradient estimates upon differentiation. At each iteration of inference procedure we choose random subset of AOIs as a mini-batch, compute differentiable ELBO estimate based on this mini-batch and update the variational parameters via automatic differentiation. We use PyTorch's Adam optimizer with the learning rate of $5\times 10^{-3}$ and keep other parameters at their default values. 

\subsection*{Data simulation}

Simulated data were produced using the generative model (Algorithm 1). Each simulation has the size of the data set ($D=14$, $N$, $F$, $N_c$, $F_c$) as an input and a subset of parameters ($K=2$, $\pi$, $\lambda$, $g$, $\sigma^{xy}$, $b$, $h$, $w$, $\delta$) being set to desired values while  the remaining parameters ($\theta$, $m$, $x$, $y$) and resulting noisy images ($D$) are sampled from distributions. Fixed parameter values and data set sizes are provided in Supplementary Data.

For kinetic simulations, $\theta$ was modeled using a discrete Markov process with initial probability of each state given by $\mathsf{init} \in \Delta_K$ and the transition probability matrix is given by $\mathsf{trans} \in (\Delta_K)^K$ where $\Delta_K$ denotes $K-1$-dimensional probability simplex. We assume that the Markov process is at equilibrium and initialized the chain with the equilibrium probabilities:
%
\begin{subequations}
\begin{align}
    \mathsf{init} &= \begin{pmatrix} \frac{k_\mathrm{off}}{k_\mathrm{on} + k_\mathrm{off}} & \frac{k_\mathrm{on}}{2\left( k_\mathrm{on} + k_\mathrm{off} \right)} & \frac{k_\mathrm{on}}{2\left( k_\mathrm{on} + k_\mathrm{off} \right)} \end{pmatrix} \\
    \mathsf{trans} &= \begin{pmatrix} 1 - k_\mathrm{on} & k_\mathrm{on}/2 & k_\mathrm{on}/2 \\ k_\mathrm{off} & (1 - k_\mathrm{off})/2 & (1 - k_\mathrm{off})/2 \\ k_\mathrm{off} & (1 - k_\mathrm{off})/2 & (1 - k_\mathrm{off})/2 \end{pmatrix}
\end{align}
\end{subequations}

\noindent
where $k_{\mathrm{on}}$ and $k_{\mathrm{off}}$ are the apparent first-order binding and dissociation rate constants in units of $\mathrm{s}^{-1}$, respectively, assuming 1 s/frame.

For posterior predictive checking, simulated images were produced ($D^\mathrm{rep}$) using Tapqir's generative model where model parameters were sampled from the posterior distribution $p(\psi|D)$ which is approximated by the variational distribution $q(\psi)$. % reference Figure S3 (sampling from posterior of simulated data)

\begin{equation}
    D^\mathrm{rep} | D \sim p(I^\mathrm{rep} | \phi) p(\delta^\mathrm{rep}) p(\psi | D)
\end{equation}

\subsection*{Classification accuracy statistics}
The probability, $p(\mathsf{specific})$, that a target-specific fluorescence spot is present in a given image is calculated as:

\begin{equation}
    p(\mathsf{specific}) = p(\theta > 0)
\end{equation}
As a metric of classification accuracy we use three commonly used statistics -- recall, precision, and Matthews Correlation Coefficient \cite{Matthews1975-rw}
\begin{equation}
    \mathrm{Recall} = \dfrac{\mathrm{TP}}{\mathrm{TP} + \mathrm{FN}}
\end{equation}

\begin{equation}
    \mathrm{Precision} = \dfrac{\mathrm{TP}}{\mathrm{TP} + \mathrm{FP}}
\end{equation}

\begin{equation}
    \mathrm{MCC} =
        \dfrac{\mathrm{TP} \cdot \mathrm{TN} - \mathrm{FP} \cdot \mathrm{FN}}
        {\sqrt{(\mathrm{TP} + \mathrm{FP}) (\mathrm{TP} + \mathrm{FN}) (\mathrm{TN} + \mathrm{FP}) (\mathrm{TN} + \mathrm{FN})}}
\end{equation}

\noindent
where TP is true positives, TN is true negatives, FP is false positives, and FN is false negatives (ref).

\subsubsection*{SNR}

We define SNR as:

\begin{equation}
    \mathrm{SNR} = \mathsf{mean} \left( \dfrac{\mathsf{signal}}{\sqrt{\sigma^2_{\mathsf{offset}} + \sigma^2_{\mathsf{background}}}} \right)
\end{equation}

where $\mathsf{signal}$ designates spot signal above background, $\sigma^2_{\mathsf{background}} = b \cdot g$ the variance of the background intensity, and $\sigma^2_{\mathsf{offset}}$ the variance of the offset intensity.

Spot signal is calculated as weighted average of total signal minus mean background and mean offset signals:

\begin{subequations}
\begin{align}
    \mathsf{weight} &= \dfrac{1}{2 \pi \cdot w^2} \exp{\left( -\dfrac{(i-x)^2 + (j-y)^2}{2 \cdot w^2} \right)} \\
    \mathsf{signal}_{\mathsf{spot}(k)} &=  \sum_{\substack{\mathsf{pixelX} \\ \mathsf{pixelY}}} D \cdot \mathsf{weight}_{\mathsf{spot}(k)} - b_{\mathrm{mean}} - \delta_\mathrm{mean}
\end{align}
\end{subequations}

For simulated data theoretical signal can be directly calculated as

\begin{equation}
    \mathsf{signal}_{\mathsf{spot}(k)} =  \sum_{\substack{\mathsf{pixelX} \\ \mathsf{pixelY}}} h \cdot \mathsf{weight}_{\mathsf{spot}(k)}^2
\end{equation}

\subsection*{Kinetic analysis}

Our procedure to estimate kinetic parameters is as follows (see Algorithm 3). For each iteration we sample binary data records $z$ from inferred $p(\mathsf{specific})$. Then we compute maximum-likelihood estimate of parameter $\hat{k}_\mathrm{on}$ and $\hat{k}_\mathrm{off}$ using two-state hidden Markov model. After completing 2000 iterations we compute mean and credible interval (highest posterior density interval) from the distributions of $\hat{k}_\mathrm{on}$ and $\hat{k}_\mathrm{off}$.

For two-state hidden Markov model the maximum-likelihood estimate $\hat{k}_\mathrm{on}$ and $\hat{k}_\mathrm{off}$ are given by

\begin{subequations}
\begin{align}
    \hat{k} &= \dfrac{\sum_{n=0}^{N-1} \sum_{f=1}^{F-1}(1 - z_{n,f-1})z_{n,f}}{\sum_{n=0}^{N-1} \sum_{f=1}^{F-1} (1 - z_{n, f-1})} \\
    \hat{k}_\mathsf{on} &= \dfrac{\sum_{n=0}^{N-1} \sum_{f=1}^{F-1}\left( 1 - z_{\mathsf{AOI}(n),\mathsf{Frame}(f-1)} \right) z_{\mathsf{AOI}(n),\mathsf{Frame}(f)}}{\sum_{n^\prime=0}^{N-1} \sum_{f^\prime=1}^{F-1} \left(1 - z_{\mathsf{AOI} (n^\prime), \mathsf{Frame}( f^\prime-1)} \right)} \\
    \hat{k}_\mathsf{off} &= \dfrac{\sum_{n=0}^{N-1} \sum_{f=1}^{F-1} z_{\mathsf{AOI}(n),\mathsf{Frame}(f)} \left( 1 - z_{\mathsf{AOI}(n),\mathsf{Frame}(f+1)} \right) }{\sum_{n^\prime=0}^{N-1} \sum_{f^\prime=1}^{F-1} z_{\mathsf{AOI} (n^\prime), \mathsf{Frame}( f^\prime)} }
\end{align}
\end{subequations}

\paragraph{Algorithm 3.} Monte Carlo sampling for parameter estimation. \\
\begin{algorithmic}[1]
\For{$i = 1, 2, \dots, 1000 $}
    \State Sample binary $z$ from approximate posterior $p(\mathsf{specific})$
    \State Calculate $\Delta t$ from $z$
    \State Calculate $\hat{k}_i$ from $\Delta t$
\EndFor{}
\State Calculate mean and CI from the distribution of $\hat{k}$
\end{algorithmic}

%section and table of  fixed parameter values

